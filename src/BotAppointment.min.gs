const config_route={linkCommands:[{template:/^\/start$/,method:"start::run"},{template:/^\/admin$/,method:"admin::run"}],buttonCommands:[{name:"start.keyboard.btn_1",method:"appointment::run"},{name:"start.keyboard.btn_2",method:"notes::run"}]};class Model{static find(){return new this}getColumns(){return mapClasses[this.constructor.name].table().columns}getSheetName(){return mapClasses[this.constructor.name].table().name}getFile(){return SpreadsheetApp.openById(config.sheet)}getSheet(){return this.getFile().getSheetByName(this.getSheetName())}getRange(e){let t=getLetterByIndex(e);return t+"1:"+t}save(){return isSet(this.hash)?this.update():this.insert()}insert(){let e=this.getColumns(),t=this.getSheet();this.hash=getRandomStr(8);let s=e.map((function(e){return isSet(this[e])?this[e]:null}).bind(this));return t.appendRow(s),this}update(){let e=this.findIndex("hash"),t=this.findOneBy("hash",this.hash);if(!isNull(t)){let s=this.getSheet(),i=this.getRowIndex(e,this.hash);for(let n in t)if(t[n]!==this[n]){let r=this.findIndex(n);s.getRange(i,r).setValue(this[n])}}return this}getRowIndex(e,t){let s=this.getSheet().getRange(this.getRange(e)),i=s.createTextFinder(t).matchEntireCell(!0).findNext();return isNull(i)?null:i.getRow()}getResult(e,t=!1){return e.length?t?e.map((function(e){return this.getSelfObject(e)}).bind(this)):this.getSelfObject(e[0]):t?[]:null}getSelfObject(e){if(e.length){let t=new mapClasses[this.constructor.name];return this.getColumns().forEach(function(s,i){t[s]=e[i]}),t}return null}findIndex(e){return findIndex(this.getColumns(),e,1)}all(){return this.getResult(this.getSheet().getDataRange().getValues(),!0)}getMaxByColumn(e){let t=this.findIndex(e),s=this.getSheet(),i=s.getRange(2,t,s.getLastRow()).getValues();return Math.max.apply(null,i)}findOneBy(e,t){let s=this.findIndex(e),i=this.getRowIndex(s,t),n=this.getColumns().length;return isNull(i)?null:this.getResult(this.getSheet().getRange(i,1,1,n).getValues())}hasOne(e,t,s){return mapClasses[e].find().findOneBy(t,this[s])}findOneByParams(e=[],t=null){return this.getResultByParams(e,"one",t)}findAllByParams(e=[],t=null){return this.getResultByParams(e,"all",t)}getResultByParams(e,t,s){let i=this.findByParams(e);if(i.length){if(!isNull(s)){let[n,r]=s;i.sort(function(e,t){return e[n]>t[n]?r?1:-1:r?-1:1})}return"one"===t?i[0]:i}return[]}getCountByParams(e=[]){return this.findByParams(e,!1).length}findByParams(e=[],t=!0){if(e.length){let s=this.getColumns(),i={};e.forEach((function(e){let[t,n,r,o]=e,l=s.indexOf(t)+1;l&&(i["_"+l]=this.getFilterCriteria(t,n,r,o))}).bind(this));let n=this.getSheet(),r=n.getRange(n.getDataRange().getA1Notation()),o=r.createFilter();for(let l in i)o.setColumnFilterCriteria(+l.slice(1),i[l]);let h=this.getResultAfterFilter(t);return o.remove(),h}return[]}getResultAfterFilter(e=!0){let t=this.getSheet(),s=t.getDataRange().getValues(),i=s.filter((e,s)=>!!s&&!t.isRowHiddenByFilter(s+=1));return e?this.getResult(i,!0):i}getFilterCriteria(e,t,s,i){let n=s.toLowerCase().includes("between"),r=Array.isArray(i),o=[];if(n)o=i;else if(r){let l="REGEXMATCH(TO_TEXT("+this.getRange(this.findIndex(e))+'); "('+i.join("|")+')")';o="==="===s?["="+l]:["=NOT("+l+")"]}else o.push(i);return SpreadsheetApp.newFilterCriteria()[this.getFilterCriteriaMethod(t,s,Array.isArray(i))](...o).build()}getFilterCriteriaMethod(e,t,s){if("null"===t);else if("not_null"===t)return"whenCellNotEmpty";else if("like"===t){if("string"===e)return"whenTextContains"}else if("_like"===t){if("string"===e)return"whenTextStartsWith"}else if("like_"===t){if("string"===e)return"whenTextEndsWith"}else if("not_like"===t){if("string"===e)return"whenTextDoesNotContain"}else if("==="===t){if("string"===e)return s?"whenFormulaSatisfied":"whenTextEqualTo";if("number"===e)return s?"whenFormulaSatisfied":"whenNumberEqualTo";if("date"===e)return s?"whenFormulaSatisfied":"whenDateEqualTo"}else if("!=="===t){if("string"===e)return s?"whenFormulaSatisfied":"whenTextNotEqualTo";if("number"===e)return s?"whenFormulaSatisfied":"whenNumberNotEqualTo";if("date"===e)return s?"whenFormulaSatisfied":"whenDateNotEqualTo"}else if(">"===t){if("number"===e)return"whenNumberGreaterThan";if("date"===e)return"whenDateAfter"}else if(">="===t){if("number"===e)return"whenNumberGreaterThanOrEqualTo"}else if("<"===t){if("number"===e)return"whenNumberLessThan";if("date"===e)return"whenDateBefore"}else if("<="===t){if("number"===e)return"whenNumberLessThanOrEqualTo"}else if("between"===t){if("number"===e)return"whenNumberBetween"}else if("not_between"===t&&"number"===e)return"whenNumberNotBetween";return"whenCellEmpty"}delete(){let e=this.getRowIndex(this.findIndex("hash"),this.hash);this.getSheet().deleteRow(e)}getNextPosition(e="position"){let t=this.getMaxByColumn(e);return 100-t%100+t}}class Bot{constructor(e,t){this.token=e,this.data=t}getUpdate(){return this.data||null}getUpdateType(){let e=this.getUpdate();for(let t of["message","callback_query","edited_message","inline_query","channel_post"])if(t in e)return t;return null}getMessage(){return this.isMessage()?this.getUpdate().message||null:this.isCallBack()&&this.getCallbackQuery().message||null}getCallbackQuery(){return"callback_query"in this.getUpdate()?this.getUpdate().callback_query:null}getInlineQuery(){return"inline_query"in this.getUpdate()?this.getUpdate().inline_query:null}getFrom(){return this.isMessage()?"from"in this.getMessage()?this.getMessage().from:null:this.isInline()?"from"in this.getInlineQuery()?this.getInlineQuery().from:null:this.isCallBack()?"from"in this.getCallbackQuery()?this.getCallbackQuery().from:null:null}getChat(){return"chat"in this.getMessage()?this.getMessage().chat:null}getUserData(){return{uid:this.getFrom().id,firstname:this.getFromFirstName(),lastname:this.getFromLastName(),username:this.getFromUserName(),lang:this.getFromUserLang()}}getEntities(){return this.isMessage()?this.isText()?"entities"in this.getMessage()?this.getMessage().entities:null:"caption_entities"in this.getMessage()?this.getMessage().caption_entities:null:null}getMessageText(){return this.isText()?this.getMessage().text??null:["audio","document","photo","animation","video","voice"].includes(this.getMessageType())?this.getMessage().caption??null:null}getMessageType(){let e=this.getMessage();for(let t of["text","photo","audio","document","animation","sticker","voice","video_note","video","location"])if(t in e)return t;return null}getMessageFileId(){let e=this.data.message,t=this.getMessageType();return"photo"===t?e.photo.pop().file_id:e[t].file_id}getMessageId(){return"message_id"in this.getMessage()?this.getMessage().message_id:null}getCallbackQueryData(){return"data"in this.getCallbackQuery()?this.getCallbackQuery().data:null}getCallbackQueryId(){return"id"in this.getCallbackQuery()?this.getCallbackQuery().id:null}getChatType(){return"type"in this.getChat()?this.getChat().type:null}getChatId(){return"id"in this.getChat()?this.getChat().id:0}getFromId(){return"id"in this.getFrom()?this.getFrom().id:0}getFromFirstName(){return"first_name"in this.getFrom()?this.getFrom().first_name:""}getFromLastName(){return"last_name"in this.getFrom()?this.getFrom().last_name:""}getFromUserName(){return"username"in this.getFrom()?this.getFrom().username:""}getFromUserLang(){return"language_code"in this.getFrom()?this.getFrom().language_code:"ru"}getFromFullName(){return(this.getFromFirstName()+" "+this.getFromLastName()).trim()}isMessage(){return"message"===this.getUpdateType()}isCallBack(){return"callback_query"===this.getUpdateType()}isInline(){return"inline_query"===this.getUpdateType()}isText(){return"text"===this.getMessageType()}isPhoto(){return"photo"===this.getMessageType()}isAudio(){return"audio"===this.getMessageType()}isDocument(){return"document"===this.getMessageType()}isAnimation(){return"animation"===this.getMessageType()}isSticker(){return"sticker"===this.getMessageType()}isVoice(){return"voice"===this.getMessageType()}isVideoNote(){return"video_note"===this.getMessageType()}isVideo(){return"video"===this.getMessageType()}isLocation(){return"location"===this.getMessageType()}isGroup(){return["group","supergroup"].includes(this.getChatType())}isPrivate(){return"private"===this.getChatType()}sendChatAction(e,t="typing"){let s={method:"sendChatAction",chat_id:String(e),action:t};return this.query(s)}notice(e=null,t=!1){if(this.isCallBack()){let s={method:"answerCallbackQuery",callback_query_id:String(this.getCallbackQueryId()),show_alert:t};return isNull(e)||(s.text=e),this.query(s)}}noticeDelete(e=null,t=!1){this.isCallBack()&&(this.notice(e,t),this.deleteMessageSelf())}deleteMessageSelf(){if(this.deleted_message!==this.getChatId()+"_"+this.getMessageId())return this.deleteMessage(this.getChatId(),this.getMessageId())}deleteMessage(e,t){this.deleted_message=e+"_"+t;let s={method:"deleteMessage",chat_id:String(e),message_id:String(t)};return this.query(s)}buildInlineKeyboardButton(e,t=null,s=null,i=null){let n={text:e};return isNull(s)?isNull(t)?isNull(i)||(n.switch_inline_query=i):n.callback_data=t:n.url=s,n}buildInlineKeyBoard(e){return JSON.stringify({inline_keyboard:e})}buildKeyboardButton(e,t=!1,s=!1){return{text:e,request_contact:t,request_location:s}}buildKeyBoard(e,t=!1,s=!0,i=!0){return JSON.stringify({keyboard:e,one_time_keyboard:t,resize_keyboard:s,selective:i})}sendMessage(e,t,s=null,i=!1,n=!1){let r={method:"sendMessage",chat_id:String(e),text:t,parse_mode:"HTML",disable_web_page_preview:n};return!isNull(s)&&Array.isArray(s)&&(r.reply_markup=i?this.buildKeyBoard(s):this.buildInlineKeyBoard(s)),this.query(r)}sendVideo(e,t,s=null,i=null,n=!1){let r={method:"sendVideo",chat_id:String(e),video:t,parse_mode:"HTML",disable_web_page_preview:n};return isNull(s)||(r.caption=s),!isNull(i)&&Array.isArray(i)&&(r.reply_markup=this.buildInlineKeyBoard(i)),this.query(r)}sendPhoto(e,t,s=null,i=null,n=!1){let r={method:"sendPhoto",chat_id:String(e),photo:t,parse_mode:"HTML",disable_web_page_preview:n};return isNull(s)||(r.caption=s),!isNull(i)&&Array.isArray(i)&&(r.reply_markup=this.buildInlineKeyBoard(i)),this.query(r)}editMessageReplyMarkup(e,t,s){let i={method:"editMessageReplyMarkup",chat_id:String(e),message_id:String(t),reply_markup:this.buildInlineKeyBoard(s)};return this.query(i)}editMessageText(e,t,s,i=null,n=!1,r=!1){let o={method:"editMessageText",chat_id:String(e),message_id:String(t),text:s,parse_mode:"HTML",disable_web_page_preview:r};return!isNull(i)&&Array.isArray(i)&&(o.reply_markup=n?this.buildKeyBoard(i):this.buildInlineKeyBoard(i)),this.query(o)}editMessageMedia(e,t,s,i=null){let n={method:"editMessageMedia",chat_id:String(e),message_id:String(t),media:JSON.stringify(s)};return!isNull(i)&&Array.isArray(i)&&(n.reply_markup=this.buildInlineKeyBoard(i)),this.query(n)}inputMedia(e,t,s=null){let i={type:t,media:e,parse_mode:"html"};return isNull(s)||(i.caption=s),i}query(e){return JSON.parse(UrlFetchApp.fetch(config.apiUrl+this.token+"/",{method:"post",payload:e}).getContentText())}}class Lang{constructor(e="ru"){this.langParams=config_lang,this.setLang(e)}setLang(e){this.lang=isSet(this.langParams[e])?e:"ru"}getParamByDot(e,t){let s=e.shift();return e.length>0?this.getParamByDot(e,t[s]):t[s]}getParam(e,t={}){let s=this.getParamByDot(e.split("."),this.langParams[this.lang]);if(!isSet(s))return"Unknown Text";if(Object.keys(t).length>0)for(let i in t){let n=RegExp("{"+i+"}","gi");s=s.replace(n,t[i])}return s}}class Note extends Model{static table(){return{name:"Notes",columns:["hash","uid","name","phone","pay","date","type","status","cal_id","created_at"]}}static getFields(){return[{type:"text",skip:!1,validate:"^[+]{1}[1-9][0-9]{9,14}$",name:"phone",buttons:!1},{type:"text",skip:!1,validate:!1,name:"name",buttons:!1},{type:"callBack",skip:!1,validate:!1,name:"pay",buttons:3},]}static create(e,t){let s=new this;return s.uid=e,s.name="",s.phone="",s.pay="",s.date=t,s.cal_id="",s.status="new",s.type=0,s.created_at=getDateToSeconds(),s.save()}getName(){return this.name}setName(e){return this.name=e,this.save()}getPhone(){return this.phone}setPhone(e){return this.phone=e,this.save()}getPay(){return this.pay}setPay(e){return this.pay=e,this.save()}getType(){return this.type}setType(e){return this.type=e,this.save()}getDate(){return this.date}setDate(e){return this.type=e,this.save()}getStatus(){return this.status}setStatus(e){return this.status=e,this.save()}getCalId(){return this.cal_id}setCalId(e){return this.cal_id=e,this.save()}setSuccess(e){return this.type=1,this.cal_id=e,this.save()}setCanceled(){return this.status="canceled",this.cal_id="",this.save()}_user(){return this.hasOne("User","uid","uid")}static deleteOld(e){this.find().findAllByParams([["uid","number","===",e],["type","number","===",0]]).forEach(function(e){e.delete()})}}class Page extends Model{static table(){return{name:"Pages",columns:["hash","type","image","description","description_entities"]}}static getFields(){return[{type:"text",db_name:"description",validate:"string",required:!0},{type:"photo",db_name:"image",validate:!1,required:!1},]}static getPage(e){let t=this.find().findOneBy("type",e);return t||(t=this.create(e)),t}static create(e){let t=new this;return t.type=e,t.image="",t.description="",t.description_entities="",t.entities="",t.save()}getDescription(){return isEmpty(this.description)?null:prepareMessageWithEntities(this.description,this.getDescriptionEntities())}setDescription(e){return this.description=e,this.save()}getDescriptionEntities(){return isEmpty(this.description_entities)?null:JSON.parse(this.description_entities)}setDescriptionEntities(e){return this.description_entities=e,this.save()}getImage(){return isEmpty(this.image)?null:this.image}setImage(e){return this.image=e,this.save()}}class Route{constructor(e){this.config=config_route,this.wh=e}checkCommand(e){if(this.config.linkCommands.length>0){for(let t of this.config.linkCommands)if(t.template.test(e))return t.result=!0,t}if(this.config.buttonCommands.length>0){for(let s of this.config.buttonCommands)if(RegExp("^"+this.wh.lang.getParam(s.name)+"$").test(e))return s.result=!0,s}return{result:!1}}write(){let e=this.wh.user.getAction();return 0!==e.length?{result:!0,method:e}:{result:!1}}run(){if(this.wh.bot.isMessage()){let e=this.write();if(this.wh.bot.isText()){let t=this.checkCommand(this.wh.bot.getMessageText());e.result&&!t.result?this.goToAction(e.method):t.result&&(this.wh.user.setAction(""),this.goToAction(t.method))}else e.result&&this.goToAction(e.method)}else if(this.wh.bot.isCallBack()){this.wh.user.setAction("");let s=this.wh.bot.getCallbackQueryData();this.goToAction(s)}}goToAction(e){let[t,s]=e.split("::"),i="Controller"+ucfirst(t,!1);if(Object.keys(mapControllers).includes(i)){let n=new mapControllers[i](this.wh),r=s.split("_").shift();"function"==typeof n[r]&&n[r]()}return!0}}class User extends Model{static table(){return{name:"Users",columns:["hash","uid","name","username","lang","action","created_at","updated_at"]}}static getUser(e){let t=this.find().findOneBy("uid",e.uid),s=getDateToSeconds();return isNull(t)&&((t=new this).uid=e.uid,t.action="",t.created_at=s),t.name=(e.firstname+" "+e.lastname).trim(),t.username=e.username,t.lang=e.lang,t.updated_at=s,t.save()}getAction(){return this.action}setAction(e){this.action=e,this.save()}}class Controller{constructor(e){this.wh=e}}class ControllerAdmin extends Controller{static before(e){if(!e.isAdmin())throw e.bot.isCallBack()&&e.bot.notice(),e.bot.sendMessage(e.bot.getFromId(),e.lang.getParam("error._403")),Error("403 - stop")}run(){this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete(),ControllerAdmin.before(this.wh);let e=[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("admin.controller.btn.about"),"adminAbout::run_0")],[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("admin.controller.btn.notes"),"adminNotes::run_0")],];this.wh.bot.sendMessage(this.wh.bot.getFromId(),this.wh.lang.getParam("admin.hello"),e)}}class ControllerAdminAbout extends Controller{run(){this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete(),ControllerAdmin.before(this.wh);let e=Page.getPage("about"),t=isNull(e.getDescription())?this.wh.lang.getParam("page.empty"):e.getDescription(),s=e.getImage(),i=[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("admin.page.btn_edit"),"adminAbout::form_0")],[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.back"),"admin::run_0")],];s?this.wh.bot.sendPhoto(this.wh.bot.getFromId(),s,t,i):this.wh.bot.sendMessage(this.wh.bot.getFromId(),t,i)}form(e=null){this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete(),ControllerAdmin.before(this.wh);let t=paramsFromText(isNull(e)?this.wh.bot.getCallbackQueryData():e),s=[],i=Page.getFields()[+t[1]];if(isSet(i)){let n=Page.getPage("about");this.wh.user.setAction("adminAbout::update_"+t[1]);let r=!i.required,o=n["get"+ucfirst(i.db_name)](),l="",h={};h.db_name=this.wh.lang.getParam("admin.page."+i.db_name);let u=+t[1]+1;isNull(o)||(h.value=o,r=!0,"photo"===i.type?s.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("admin.icon.remove"),"adminAbout::deleteMedia_"+t[1])]):"text"===i.type&&(l=this.wh.lang.getParam("admin.page.form."+i.type+"_old",h))),h.old_value=l,r&&s.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.skip"),"adminAbout::form_"+u)]);let g=this.wh.lang.getParam("admin.page.form."+i.type,h);s.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.cancel"),"adminAbout::run_0")]),"photo"!==i.type||isNull(o)?this.wh.bot.sendMessage(this.wh.bot.getFromId(),g,s):this.wh.bot.sendPhoto(this.wh.bot.getFromId(),o,g,s)}else this.run()}update(e=null){ControllerAdmin.before(this.wh);let t=paramsFromText(this.wh.user.getAction()),s=Page.getFields(),i=s[+t[1]],n="set"+ucfirst(i.db_name),r="is"+ucfirst(i.type),o=[],l;if(o.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.back"),"adminAbout::run_0")]),this.wh.bot[r]()){let h=Page.getPage("about");if("photo"===i.type)l=!!h[n](this.wh.bot.getMessageFileId());else if("text"===i.type){let u=this.wh.bot.getMessageText();if(i.validate&&"number"===i.validate)u=isNaN(+u)?1:+u;else{let g=this.wh.bot.getEntities();!isNull(g)&&h["set"+this.wh.prepareMethod(i.db_name+"_entities")](JSON.stringify(g))}l=!!h[n](u)}else l=!1;if(l){this.wh.user.setAction("");let d=+t[1]+1;isSet(s[d])?this.form("param_"+d):this.run()}else this.wh.bot.sendMessage(this.wh.bot.getFromId(),this.wh.lang.getParam("error.load"),o)}else this.wh.bot.sendMessage(this.wh.bot.getFromId(),this.wh.lang.getParam("error.method"),o)}deleteMedia(){ControllerAdmin.before(this.wh);let e=paramsFromText(this.wh.bot.getCallbackQueryData()),t=Page.getPage("about");this.wh.bot.noticeDelete(),t.setImage(""),this.form("param_"+e[1])}}class ControllerAdminNotes extends Controller{run(e=null){this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete(),this.date("params_"+setBeforeZero(new Date().getMonth())+"_"+new Date().getFullYear())}date(e=null){this.wh.bot.isCallBack()&&isNull(e)&&this.wh.bot.notice(),ControllerAdmin.before(this.wh);let t=paramsFromText(isNull(e)?this.wh.bot.getCallbackQueryData():e),s=new Date(+t[2],+t[1]),i=new Date(new Date(s).setMonth(s.getMonth()-1)),n=new Date(new Date(s).setMonth(s.getMonth()+1)),r=[];r.push([this.wh.bot.buildInlineKeyboardButton("<<<","adminNotes::date_"+setBeforeZero(i.getMonth())+"_"+i.getFullYear()),this.wh.bot.buildInlineKeyboardButton(setBeforeZero(+t[1]+1)+"."+t[2],"appointment::inline_0"),this.wh.bot.buildInlineKeyboardButton(">>>","adminNotes::date_"+setBeforeZero(n.getMonth())+"_"+n.getFullYear())]);let o=createCalendar(+t[2],+t[1]+1),l=Note.find().findAllByParams([["type","number","===",1],["date","number","between",[getDateToSeconds(s),getDateToSeconds(n)]]]),h={};l.forEach(function(e,t){let s="_"+new Date(1e3*+e.date).getDate();isSet(h[s])||(h[s]=[]),h[s].push(e.hash)}),o.forEach(function(e){r[r.length]=[],e.forEach(function(e){s=e>0?new Date(new Date(s).setDate(e)):s;let t="_"+e in h;r[r.length-1].push(this.wh.bot.buildInlineKeyboardButton(t?"*"+e:e,t?"adminNotes::viewDay_"+getDateToSeconds(s):"appointment::inline_0"))},this)},this);let u=this.wh.lang.getParam("admin.order.all.selectDay");isNull(e)?this.wh.bot.editMessageText(this.wh.user.uid,this.wh.bot.getMessageId(),u,r):this.wh.bot.sendMessage(this.wh.user.uid,u,r)}viewDay(e=null){ControllerAdmin.before(this.wh);let t=paramsFromText(isNull(e)?this.wh.bot.isCallBack()?this.wh.bot.getCallbackQueryData():"param_0_0_0":e);t[2]=isSet(t[2])?+t[2]:0,t[3]=isSet(t[3])?+t[3]:0;let s=Note.find().findAllByParams([["type","number","===",1],["date","number","between",[+t[1],+t[1]+86400]]],["date",!0]),i=s.length;if((s=s.filter(function(e,s){return s>=+t[2]&&s<+t[2]+1})).length){let n=s[0],r=this.getTextOrder(n,+t[2],i),o=this.getButtonsOrder(t[1],i,+t[2],n);+t[3]?(this.wh.bot.isCallBack()&&this.wh.bot.notice(),this.wh.bot.editMessageText(this.wh.bot.getFromId(),this.wh.bot.getMessageId(),r,o)):(this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete(),this.wh.bot.sendMessage(this.wh.bot.getFromId(),r,o))}else if(+t[2]>0)this.viewDay("params_"+t[1]+"_0_0");else if(isNull(e))this.wh.bot.notice(this.wh.lang.getParam("order.empty"));else{this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete();let l=new Date(1e3*+t[1]),h=[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.back"),"adminNotes::date_"+setBeforeZero(l.getMonth())+"_"+l.getFullYear())]];this.wh.bot.sendMessage(this.wh.user.uid,this.wh.lang.getParam("order.empty"),h)}}getTextOrder(e,t,s){let i=new Date,n=e._user();return this.wh.lang.getParam("order.body_admin",{hash:e.hash.toUpperCase(),user:n?e._user().name:"Unknown user",date:getDateToFormat(e.date).slice(0,-3),phone:e.getPhone(),name:e.getName(),pay:this.wh.lang.getParam("order.pay._"+e.getPay()),status:e.date>getDateToSeconds(i)?this.wh.lang.getParam("order.getStatus",{status:this.wh.lang.getParam("order.status."+e.getStatus())}):"",page:+t+1,total:s})}getButtonsOrder(e,t,s,i){let n=new Date(1e3*+e),r=new Date,o=[];return t>1&&o.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.prev"),"adminNotes::viewDay_"+e+"_"+(s-1<0?t-1:s-1)+"_1"),this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.next"),"adminNotes::viewDay_"+e+"_"+(s+1>=t?0:s+1)+"_1"),]),i.date>getDateToSeconds(r)&&("new"===i.status&&o.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.setAccept"),"adminNotes::accept_"+i.hash+"_"+e+"_"+t+"_"+s)]),"canceled"!==i.status&&o.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.cancel"),"adminNotes::cancelAsk_"+i.hash+"_"+e+"_"+i.date+"_"+t+"_"+s)])),o.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.back"),"adminNotes::date_"+setBeforeZero(n.getMonth())+"_"+n.getFullYear())]),o}accept(){ControllerAdmin.before(this.wh);let e=paramsFromText(this.wh.bot.getCallbackQueryData()),t=Note.find().findOneBy("hash",e[1]);if(t){t.setStatus("inWork"),this.noticeUser(t,!0);let s=this.getTextOrder(t,e[4],e[3]),i=this.getButtonsOrder(e[2],e[3],e[4],t);this.wh.bot.editMessageText(this.wh.user.uid,this.wh.bot.getMessageId(),s,i)}else this.wh.bot.notice(this.wh.lang.getParam("error._404"))}cancelAsk(){this.wh.bot.noticeDelete(),ControllerAdmin.before(this.wh);let e=paramsFromText(this.wh.bot.getCallbackQueryData()),t=this.wh.lang.getParam("admin.order.askCancel",{date:getDateToFormat(+e[3]).slice(0,-3)}),s=[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.yes"),"adminNotes::cancel_"+e[1]+"_"+e[2]+"_"+e[4]+"_"+e[5]),this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.no"),"adminNotes::viewDay_"+e[2]+"_0_0"),]];this.wh.bot.sendMessage(this.wh.user.uid,t,s)}cancel(){let e=paramsFromText(this.wh.bot.getCallbackQueryData()),t=Note.find().findOneBy("hash",e[1]);if(t){let s=CalendarApp.getCalendarById(config.calendar).getEventById(t.cal_id);if(!isNull(s)){this.wh.bot.notice(),this.noticeUser(t),s.deleteEvent(),t.setCanceled();let i=this.getTextOrder(t,e[4],e[3]),n=this.getButtonsOrder(e[2],e[3],e[4],t);this.wh.bot.editMessageText(this.wh.user.uid,this.wh.bot.getMessageId(),i,n)}}else this.wh.bot.notice(this.wh.lang.getParam("error._404"))}noticeUser(e,t=!1){let s=[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.orders"),"notes::run_"+ +!+t+"_0")]],i=this.wh.lang.getParam("order.noticeUser_"+ +t,{date:getDateToFormat(e.date).slice(0,-3),hash:e.hash.toUpperCase()});this.wh.bot.sendMessage(+e.uid,i,s)}}class ControllerAppointment extends Controller{run(e=null){this.dateForm("params_"+setBeforeZero(new Date().getMonth())+"_"+new Date().getFullYear())}dateForm(e=null){this.wh.bot.isCallBack()&&this.wh.bot.notice();let t=paramsFromText(isNull(e)?this.wh.bot.getCallbackQueryData():e),s=new Date;s.setHours(0,0,0,0);let i=new Date(new Date().setDate(s.getDate()+config.afterToday));i.setHours(0,0,0,0);let n=new Date(+t[2],+t[1]),r=new Date(new Date(n).setMonth(n.getMonth()-1)),o=new Date(new Date(n).setMonth(n.getMonth()+1)),l=CalendarApp.getCalendarById(config.calendar),h=t[2]+"-"+setBeforeZero(+t[1]+1),u=new Date(+t[2],+t[1]+1,0).getDate(),g=l.getEvents(new Date(h+"-01 00:00:00"),new Date(h+"-"+u+" 23:59:59")),d=parseEvents(g,n),m=[],c=s<n,b=i>o;m.push([this.wh.bot.buildInlineKeyboardButton(c?"<<<":"✖️✖️✖️",c?"appointment::dateForm_"+setBeforeZero(r.getMonth())+"_"+r.getFullYear():"appointment::inline_0"),this.wh.bot.buildInlineKeyboardButton(setBeforeZero(+t[1]+1)+"."+t[2],"appointment::inline_0"),this.wh.bot.buildInlineKeyboardButton(b?">>>":"✖️✖️✖️",b?"appointment::dateForm_"+setBeforeZero(o.getMonth())+"_"+o.getFullYear():"appointment::inline_0")]);let w=createCalendar(+t[2],+t[1]+1),p=0;if(w.forEach(function(e){m[m.length]=[],e.forEach(function(e){let t=getServiceTimes();n=e>0?new Date(new Date(n).setDate(e)):n,getDateToSeconds(s)===getDateToSeconds(n)&&(t=this.workTimeFilter(t));let r=checkDateNotes("_"+e in d?d["_"+e]:[],t).length>0?e:"✖️";r>0&&(r=s<=n&&n<=i?r:"✖️");let o=r>0;p+=+o,m[m.length-1].push(this.wh.bot.buildInlineKeyboardButton(r,o?"appointment::timeForm_"+getDateToSeconds(n):"appointment::inline_0"))},this)},this),p||isNull(e)){let f=this.wh.lang.getParam("order.form.date");isNull(e)?this.wh.bot.editMessageText(this.wh.user.uid,this.wh.bot.getMessageId(),f,m):this.wh.bot.sendMessage(this.wh.user.uid,f,m)}else b?this.dateForm("params_"+setBeforeZero(o.getMonth())+"_"+o.getFullYear()):this.wh.bot.sendMessage(this.wh.user.uid,this.wh.lang.getParam("order.form.error.noTimes"))}timeForm(e=null){let t=paramsFromText(isNull(e)?this.wh.bot.getCallbackQueryData():e),s=new Date(1e3*+t[1]),i=new Date;i.setHours(0,0,0,0);let n=CalendarApp.getCalendarById(config.calendar).getEventsForDay(s),r=parseEvents(n,new Date(s.getFullYear(),s.getMonth(),1)),o=getServiceTimes();getDateToSeconds(s)===getDateToSeconds(i)&&(o=this.workTimeFilter(o));let l="_"+s.getDate(),h=checkDateNotes(l in r?r[l]:[],o);if(h.length){this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete();let u=[];h.forEach(function(e,s){let[i,n]=e;u.push([this.wh.bot.buildInlineKeyboardButton(setBeforeZero(Math.floor(i/3600))+":"+setBeforeZero(i/60%60),"appointment::create_"+(+t[1]+i))])},this),u[u.length]=[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.back"),"appointment::dateForm_"+setBeforeZero(s.getMonth())+"_"+s.getFullYear())],this.wh.bot.sendMessage(this.wh.user.uid,this.wh.lang.getParam("order.form.time",{date:getDateToFormat(+t[1]).slice(0,-10)}),u)}else this.wh.bot.isCallBack()&&(this.wh.bot.noticeDelete(this.wh.lang.getParam("order.form.error.noTimes")),this.run())}create(e=null){this.wh.bot.isCallBack()&&isNull(e)&&this.wh.bot.noticeDelete(),Note.deleteOld(this.wh.user.uid);let t=paramsFromText(isNull(e)?this.wh.bot.getCallbackQueryData():e),s=Note.create(this.wh.user.uid,t[1]);this.form("params_"+s.hash+"_0")}form(e=null){this.wh.bot.isCallBack()&&isNull(e)&&this.wh.bot.noticeDelete();let t=paramsFromText(isNull(e)?this.wh.bot.getCallbackQueryData():e);t[3]=isSet(t[3])?t[3]:null;let s=Note.find().findOneByParams([["hash","string","===",t[1]],["type","number","===",0]]);if(!Array.isArray(s)){let i=Note.getFields()[+t[2]];if(!isSet(i))return this.preview("params_"+s.hash);{this.wh.user.setAction("appointment::update_"+s.hash+"_"+t[2]);let n=this.wh.lang.getParam("order.form.text._"+t[2],{error:isNull(t[3])?"":this.wh.lang.getParam("order.form.error._"+t[3])}),r=[];if("callBack"===i.type)for(let o=0;o<i.buttons;o+=1)r.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order."+i.name+"._"+o),"appointment::update_"+s.hash+"_"+t[2]+"_"+o)]);return this.wh.bot.sendMessage(this.wh.bot.getFromId(),n,r.length?r:null)}}}update(){let e=paramsFromText(this.wh.bot.isCallBack()?this.wh.bot.getCallbackQueryData():this.wh.user.getAction()),t=Note.find().findOneByParams([["hash","string","===",e[1]],["type","number","===",0]]);if(!Array.isArray(t)){let s=Note.getFields()[+e[2]];if(isSet(s)&&this.wh.bot["is"+ucfirst(s.type,!1)]()){let i="callBack"===s.type?e[3]:this.wh.bot.getMessageText();if(this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete(),s.validate&&!RegExp(s.validate).test(i))return this.form("params_"+e[1]+"_"+e[2]+"_"+e[2]);this.wh.user.setAction(""),t["set"+ucfirst(s.name,!1)](i);let n=+e[2]+1,r=Note.getFields()[n];return r?(r.skip&&t["get"+ucfirst(r.skip.step,!1)]()==r.skip.value&&(n+=1),this.form("params_"+e[1]+"_"+n)):this.preview("params_"+t.hash)}}this.wh.bot.notice(this.wh.lang.getParam("error.again"))}preview(e=null){this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete();let t=paramsFromText(isNull(e)?this.wh.bot.getCallbackQueryData():e),s=Note.find().findOneBy("hash",t[1]);if(s){let i=this.getPreviewText(s,"main"),n=[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.finish"),"appointment::finish_"+s.hash)],[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.cancel"),"start::run_0")],];this.wh.bot.sendMessage(this.wh.bot.getFromId(),i,n)}else this.wh.bot.sendMessage(this.wh.bot.getFromId(),this.wh.lang.getParam("error.again"))}finish(){let e=paramsFromText(this.wh.bot.getCallbackQueryData()),t=Note.find().findOneByParams([["hash","string","===",e[1]],["type","number","===",0]]);if(Array.isArray(t))this.wh.bot.noticeDelete(this.wh.lang.getParam("error._404"));else if(+t.date>getDateToSeconds()){let s=new Date(1e3*+t.date);s.setHours(0,0,0,0);let i=new Date;i.setHours(0,0,0,0);let n=CalendarApp.getCalendarById(config.calendar),r=n.getEventsForDay(s),o=parseEvents(r,new Date(s.getFullYear(),s.getMonth(),1)),l=getServiceTimes(),h=getDateToSeconds(s);h===getDateToSeconds(i)&&(l=this.workTimeFilter(l));let u="_"+s.getDate(),g=checkDateNotes(u in o?o[u]:[],l);if(g.length){let d=+t.date-h;if((g=g.filter(function(e,t){let[s,i]=e;return s===d})).length){let m=n.createEvent(t.name+" [#"+t.hash+"]",new Date(1e3*+t.date),new Date((+t.date+60*config.serviceDurationInMinutes)*1e3),{description:this.wh.lang.getParam("order.preview.phone",{phone:t.phone})+" "+this.wh.lang.getParam("order.preview.name",{name:t.name})+" "+this.wh.lang.getParam("order.preview.pay",{pay:this.wh.lang.getParam("order.pay._"+t.pay)})});t.setSuccess(m.getId()),this.wh.bot.noticeDelete(),this.noticeAdmin(t),this.thanks()}}}}noticeAdmin(e){let t=new Date(1e3*+e.date);t.setHours(0,0,0,0);let s=this.getPreviewText(e,"toAdminMain"),i=[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("admin.order.goToDay"),"adminNotes::viewDay_"+getDateToSeconds(t))],];this.wh.bot.sendMessage(config.admin_uid,s,i)}getPreviewText(e,t){return this.wh.lang.getParam("order.preview."+t,{hash:e.hash.toUpperCase(),body:this.wh.lang.getParam("order.preview.body",{date_body:this.wh.lang.getParam("order.preview.date",{date:getDateToFormat(e.date).slice(0,-3)}),phone_body:this.wh.lang.getParam("order.preview.phone",{phone:e.phone}),name_body:this.wh.lang.getParam("order.preview.name",{name:e.name}),pay_body:this.wh.lang.getParam("order.preview.pay",{pay:this.wh.lang.getParam("order.pay._"+e.pay)})})})}thanks(){this.wh.bot.sendMessage(this.wh.bot.getFromId(),this.wh.lang.getParam("order.success"),[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.orders"),"notes::run_0_0")],])}workTimeFilter(e){let t=new Date,s=3600*t.getHours()+60*t.getMinutes()+t.getSeconds();return e.filter(function(e){let[t,i]=e;return s<t},this)}inline(){this.wh.bot.notice("- - -")}}class ControllerNotes extends Controller{run(e=null){let t=paramsFromText(isNull(e)?this.wh.bot.isCallBack()?this.wh.bot.getCallbackQueryData():"param_0_0_0":e);t[1]=isSet(t[1])?+t[1]:0,t[2]=isSet(t[2])?+t[2]:0,t[3]=isSet(t[3])?+t[3]:0;let s=Note.find().findAllByParams([["uid","number","===",this.wh.user.uid],["type","number","===",1],],["date",!0]),i=getDateToSeconds(),n=(s=s.filter(function(e,s){return t[1]?+e.date<i||"canceled"===e.status:+e.date>i&&["new","inWork"].includes(e.status)})).length;if((s=s.filter(function(e,s){return s>=+t[2]&&s<+t[2]+1})).length){let r=s[0],o=this.getTextOrder(r,+t[1],+t[2],n),l=this.getButtonsOrder(+t[1],n,+t[2],r);+t[3]?(this.wh.bot.isCallBack()&&this.wh.bot.notice(),this.wh.bot.editMessageText(this.wh.bot.getFromId(),this.wh.bot.getMessageId(),o,l)):(this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete(),this.wh.bot.sendMessage(this.wh.bot.getFromId(),o,l))}else this.wh.bot.isCallBack()&&this.wh.bot.noticeDelete(),+t[2]>0?this.run("params_"+t[1]+"_0_0"):this.wh.bot.sendMessage(this.wh.bot.getFromId(),this.wh.lang.getParam("order.empty",{type:this.wh.lang.getParam("order.type_"+t[1])}),[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.type_"+ +!+t[1]),"notes::run_"+ +!+t[1]+"_0")]])}getTextOrder(e,t,s,i){return this.wh.lang.getParam("order.body",{type:this.wh.lang.getParam("order.type_"+t),hash:e.hash.toUpperCase(),date:getDateToFormat(e.date).slice(0,-3),phone:e.getPhone(),name:e.getName(),pay:this.wh.lang.getParam("order.pay._"+e.getPay()),status:+t&&"canceled"!==e.getStatus()?"":this.wh.lang.getParam("order.getStatus",{status:this.wh.lang.getParam("order.status."+e.getStatus())}),page:+s+1,total:i})}getButtonsOrder(e,t,s,i){let n=[];return t>1&&n.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.prev"),"notes::run_"+e+"_"+(s-1<0?t-1:s-1)+"_1"),this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.next"),"notes::run_"+e+"_"+(s+1>=t?0:s+1)+"_1"),]),+e||n.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.setCancel"),"notes::cancelAsk_"+i.hash+"_"+e+"_"+i.date)]),n.push([this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("order.type_"+ +!+e),"notes::run_"+ +!+e+"_0")]),n}cancelAsk(){this.wh.bot.noticeDelete();let e=paramsFromText(this.wh.bot.getCallbackQueryData()),t=this.wh.lang.getParam("order.askCancel",{date:getDateToFormat(+e[3]).slice(0,-3)}),s=[[this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.yes"),"notes::cancel_"+e[1]+"_"+e[2]),this.wh.bot.buildInlineKeyboardButton(this.wh.lang.getParam("go.no"),"notes::run_"+e[2]+"_0_0"),]];this.wh.bot.sendMessage(this.wh.user.uid,t,s)}cancel(){let e=paramsFromText(this.wh.bot.getCallbackQueryData()),t=Note.find().findOneBy("hash",e[1]),s=this.wh.lang.getParam("error._404");if(t){if(!isEmpty(t.cal_id)){let i=CalendarApp.getCalendarById(config.calendar).getEventById(t.cal_id);isNull(i)||(this.adminNotice(t,i),i.deleteEvent())}s="",t.delete()}this.wh.bot.noticeDelete(s),this.run("params_"+e[2]+"_0_0")}adminNotice(e,t){let s=this.wh.lang.getParam("order.noticeDeleteAdmin",{date:getDateToFormat(e.date).slice(0,-3),description:t.getDescription(),hash:e.hash.toUpperCase()});this.wh.bot.sendMessage(config.admin_uid,s)}}class ControllerStart extends Controller{run(){if(this.wh.bot.isCallBack())this.wh.bot.noticeDelete();else{let e=ControllerStart.getStartKeyboard(this.wh);this.wh.bot.sendMessage(this.wh.bot.getChatId(),"...",e,!0)}let t=null;this.wh.isAdmin()&&(t=[[this.wh.bot.buildInlineKeyboardButton("AdminPanel /admin","admin::run_0")]]);let s=Page.getPage("about"),i=s.getDescription(),n=isNull(i)?this.wh.lang.getParam("page.empty"):i,r=s.getImage();isNull(r)?this.wh.bot.sendMessage(this.wh.bot.getFromId(),n):this.wh.bot.sendPhoto(this.wh.bot.getFromId(),r,n)}static getStartKeyboard(e){return[[e.bot.buildKeyboardButton(e.lang.getParam("start.keyboard.btn_1")),e.bot.buildKeyboardButton(e.lang.getParam("start.keyboard.btn_2")),]]}}function doPost(e){if(e.parameter.token===config.token){let t=JSON.parse(e.postData.contents);new WebHook(t)}}function getMe(){let e=UrlFetchApp.fetch(config.apiUrl+config.token+"/getMe");console.log(e.getContentText())}function getWebHookInfo(){let e=UrlFetchApp.fetch(config.apiUrl+config.token+"/getWebHookInfo");console.log(e.getContentText())}function setWebHook(){let e=UrlFetchApp.fetch(config.apiUrl+config.token+"/setWebHook?url="+config.webhook+"?token="+config.token);console.log(e.getContentText())}function deleteWebHook(){let e=UrlFetchApp.fetch(config.apiUrl+config.token+"/deleteWebhook?drop_pending_updates=true");console.log(e.getContentText())}function initApp(){try{let e=SpreadsheetApp.openById(config.sheet);for(let t in mapClasses){let s=mapClasses[t],i=s.table();isNull(e.getSheetByName(i.name))&&(e.insertSheet(i.name),new s().getSheet().appendRow(i.columns))}console.log("Complete")}catch(n){console.log(n.message)}}function isSet(e){return void 0!==e}function isEmpty(e){return""===e}function isNull(e){return null===e}function logger(e,t="Logs"){try{let s=SpreadsheetApp.openById(config.sheet);null===s.getSheetByName(t)&&s.insertSheet(t),s.getSheetByName(t).appendRow([e])}catch(i){}}function ucfirst(e,t=!0){let s=e[0].toUpperCase(),i=e.slice(1);return s+(t?i.toLowerCase():i)}function findIndex(e,t,s=0){let i;return e.indexOf(t)+s}function getLetterByIndex(e){return(a=Math.floor(--e/26))>=0?getLetterByIndex(a-1)+String.fromCharCode(65+e%26):""}function getRandomStr(e=16){return Array(e).fill("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz").map(function(e){return e[Math.floor(Math.random()*e.length)]}).join("").toLowerCase()}function getDateToSeconds(e=null){let t=isNull(e)?new Date:new Date(e);return Math.floor(t.getTime()/1e3)}function getDateToFormat(e,t="ru"){let s;return new Date(1e3*e).toLocaleString(t,{year:"numeric",month:"numeric",day:"numeric",hour:"numeric",minute:"numeric",second:"numeric",timezone:"UTC"})}function paramsFromText(e){return e.split("_")}function prepareMessageWithEntities(e,t){if(null!==t&&t.length>0){let s="";return t.forEach(function(t,i,n){if(t.offset>0){let r=0===i?0:n[i-1].offset+n[i-1].length,o=t.offset-r;s+=e.substr(r,o)}let l=e.substr(t.offset,t.length);"bold"===t.type?l="<b>"+l+"</b>":"italic"===t.type?l="<i>"+l+"</i>":"code"===t.type?l="<code>"+l+"</code>":"pre"===t.type?l="<pre>"+l+"</pre>":"strikethrough"===t.type?l="<s>"+l+"</s>":"underline"===t.type?l="<u>"+l+"</u>":"spoiler"===t.type?l="<tg-spoiler>"+l+"</tg-spoiler>":"text_link"===t.type&&(l="<a href='"+t.url+"'>"+l+"</a>"),s+=l}),s+=e.substr(t[t.length-1].offset+t[t.length-1].length)}return e}function createCalendar(e,t){let s=t-1,i=new Date(e,s),n=[];n[n.length]=[];for(let r=0;r<getDay(i);r++)n[n.length-1].push("-");for(;i.getMonth()==s;)n[n.length-1].push(i.getDate()),getDay(i)%7==6&&(n[n.length]=[]),i.setDate(i.getDate()+1);if(0!=getDay(i))for(let o=getDay(i);o<7;o++)n[n.length-1].push("-");return n}function getDay(e){let t=e.getDay();return 0==t&&(t=7),t-1}function setBeforeZero(e){return("0"+e).slice(-2)}function addEvent(e,t,s,i){let n=parseInt((s-t)/1e3);if(n){let r=3600*t.getHours()+60*t.getMinutes(),o=r+n>=86400;if(isSet(i[e])||(i[e]=[]),i[e].push([r,o?86400:3600*s.getHours()+60*s.getMinutes(),]),o){let l=new Date(t.getFullYear(),t.getMonth(),t.getDate()+1);l.getMonth()===t.getMonth()&&addEvent("_"+l.getDate(),l,s,i)}}}function getConfigWorkHours(){let[e,t]=config.workHours,[s,i]=e.split(":"),[n,r]=t.split(":");return[60*+s+ +i,60*+n+ +r]}function getServiceDurationInMinutes(){return config.serviceDurationInMinutes<15?15:config.serviceDurationInMinutes}function getServiceTimes(){let[e,t]=getConfigWorkHours(),s=getServiceDurationInMinutes(),i=Math.floor((t-e)/s),n=[];for(let r=0;r<i;r+=1){let o=e%60+r*s,l=(Math.floor(e/60)+Math.floor(o/60))*60+o%60;n.push([60*l,(l+getServiceDurationInMinutes())*60])}return n}function checkDateNotes(e,t){return e.sort(function(e,t){return e[0]-t[0]}),t.filter(function(t){let[s,i]=t,n=!0;for(let r=0;r<e.length;r+=1){let[o,l]=e[r];if(s>=o&&s<l||i>o&&i<=l){n=!1;break}}return n})}function parseEvents(e,t){let s={};return e.length&&e.forEach(function(e){let i=e.getStartTime();t.getMonth()>i.getMonth()&&t.getFullYear()>=i.getFullYear()&&(i=t);let n=e.getEndTime();addEvent("_"+i.getDate(),i,n,s)}),s}class WebHook{constructor(e){try{if(config.debugger&&logger(JSON.stringify(e)),this.bot=new Bot(config.token,e),!this.bot.isPrivate())return!0;this.user=User.getUser(this.bot.getUserData()),this.lang=new Lang(this.user.lang),new Route(this).run()}catch(t){logger(t.message)}}isAdmin(){return config.admin_uid===this.user.uid}prepareMethod(e){return e.split("_").map(function(e,t){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()}).join("")}}const mapClasses={User,Note,Page},mapControllers={ControllerStart,ControllerAdmin,ControllerAdminAbout,ControllerAdminNotes,ControllerNotes,ControllerAppointment};